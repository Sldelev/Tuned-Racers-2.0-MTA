CooldownDialog = {}

local UI = exports.tunrc_UI

local PANEL_SIZE = Vector2(350, 200)
local TEXT_OFFSET = 15
local BUTTON_HEIGHT = 50

local screenSize = Vector2(UI:getScreenSize())
local isVisible = false

local ui = {}
local data = {}

local cooldownTimer

local function killCooldownTimer()
    if cooldownTimer then
        cooldownTimer:destroy()
        cooldownTimer = nil
    end
end

function CooldownDialog.show(leftTime)
    if isVisible or localPlayer:getData("activeUI") then
        return false
    end
    if type(leftTime) ~= "number" then
        return false
    end
    isVisible = true

    data.leftTime = leftTime

    CooldownDialog.update()
    if leftTime > 0 then
        cooldownTimer = Timer(CooldownDialog.update, 1000, 0)
    end

    UI:setVisible(ui.panel, true)
    showCursor(true)

    localPlayer:setData("activeUI", "sellVehicleCooldownDialog")
    return true
end

function CooldownDialog.update()
    data.leftTime = data.leftTime - 1
    if data.leftTime > 0 then
        timeLeftString = ("%02d:%02d:%02d"):format(data.leftTime / 3600, data.leftTime / 60 % 60, data.leftTime % 60)
        UI:setText(ui.timeLeft, timeLeftString)
        UI:setText(ui.text, exports.tunrc_Lang:getString("sell_vehicle_cooldown_text"))
    else
        killCooldownTimer()
        UI:setText(ui.timeLeft, exports.tunrc_Lang:getString("sell_vehicle_cooldown_available"))
        UI:setText(ui.text, '')
    end
end

function CooldownDialog.hide()
    if not isVisible then
        return false
    end
    isVisible = false

    killCooldownTimer()

    UI:setVisible(ui.panel, false)
    showCursor(false)

    localPlayer:setData("activeUI", false)
    UI:fadeScreen(false)

    return true
end

addEventHandler("onClientResourceStart", resourceRoot, function ()
    ui.panel = UI:createTrcRoundedRectangle {
		x       = (screenSize.x - PANEL_SIZE.x)  / 2,
        y       = (screenSize.y - PANEL_SIZE.y) / 2,
        width   = PANEL_SIZE.x,
        height  = PANEL_SIZE.y,
		radius = 20,
		color = tocolor(245, 245, 245),
		darkToggle = true,
		darkColor = tocolor(20, 20, 20)
	}
    UI:addChild(ui.panel)
    UI:setVisible(ui.panel, false)

    -- Заголовок
    ui.title = UI:createDpLabel {
        x        = TEXT_OFFSET,
        y        = 0,
        width    = PANEL_SIZE.x - TEXT_OFFSET * 2,
        height   = BUTTON_HEIGHT,
        alignX   = "center",
        alignY   = "center",
        clip     = true,
        locale   = "sell_vehicle_cooldown_title",
       color = tocolor (0, 0, 0),
		darkToggle = true,
		darkColor = tocolor(255, 255, 255),
        fontType = "defaultSmall",
    }
    UI:addChild(ui.panel, ui.title)

    -- Время
    ui.timeLeft = UI:createDpLabel {
        x           = TEXT_OFFSET,
        y           = BUTTON_HEIGHT,
        width       = PANEL_SIZE.x - TEXT_OFFSET * 2,
        height      = PANEL_SIZE.y - BUTTON_HEIGHT,
        alignX      = "center",
        alignY      = "top",
        clip        = true,
        wordBreak   = true,
		color = tocolor (0, 0, 0),
		darkToggle = true,
		darkColor = tocolor(255, 255, 255),
        fontType    = "defaultLarger"
    }
    UI:addChild(ui.panel, ui.timeLeft)

    -- Пояснение
    ui.text = UI:createDpLabel {
        x           = TEXT_OFFSET,
        y           = BUTTON_HEIGHT,
        width       = PANEL_SIZE.x - TEXT_OFFSET * 2,
        height      = BUTTON_HEIGHT + 25,
        alignX      = "center",
        alignY      = "bottom",
        clip        = true,
        wordBreak   = true,
        color = tocolor (0, 0, 0),
		darkToggle = true,
		darkColor = tocolor(255, 255, 255),
        fontType    = "defaultSmall"
    }
    UI:addChild(ui.panel, ui.text)
	
	-- Кнопка отмены
    ui.cancelButton = UI:createTrcRoundedRectangle {
		x      = 10,
        y      = PANEL_SIZE.y - BUTTON_HEIGHT - 10,
        width  = PANEL_SIZE.x - 20,
        height = BUTTON_HEIGHT,
		radius = 15,
		color = tocolor(200, 205, 210),
		hover = true,
		hoverColor = tocolor(130, 130, 200),
		darkToggle = true,
		darkColor = tocolor(50, 50, 50),
		hoverDarkColor = tocolor(30, 30, 30),
		shadow = true,
		locale = "sell_vehicle_cancel_button"
	}
    UI:addChild(ui.panel, ui.cancelButton)
end)

addEvent("tunrc_UI.click", false)
addEventHandler("tunrc_UI.click", resourceRoot, function (widget)
    if widget == ui.cancelButton then
        exports.tunrc_Sounds:playSound("ui_back.wav")
        CooldownDialog.hide()
    end
end)
