local a={}a.version="0.9.0"a.options={separator='&'}a.services={acap=674,cap=1026,dict=2628,ftp=21,gopher=70,http=80,https=443,iax=4569,icap=1344,imap=143,ipp=631,ldap=389,mtqp=1038,mupdate=3905,news=2009,nfs=2049,nntp=119,rtsp=554,sip=5060,snmp=161,telnet=23,tftp=69,vemmi=575,afs=1483,jms=5673,rsync=873,prospero=191,videotex=516}local b={["-"]=true,["_"]=true,["."]=true,["!"]=true,["~"]=true,["*"]=true,["'"]=true,["("]=true,[")"]=true,[":"]=true,["@"]=true,["&"]=true,["="]=true,["+"]=true,["$"]=true,[","]=true,[";"]=true}local function c(d)local d=d:gsub('+',' ')return d:gsub("%%(%x%x)",function(e)return string.char(tonumber(e,16))end)end;local function f(d)return d:gsub("([^A-Za-z0-9%_%.%-%~])",function(g)return string.upper(string.format("%%%02x",string.byte(g)))end)end;local function h(d)local d=f(d)return d:gsub('%%20','+')end;local function i(j)local k=function(e)if b[e]then return e end;return f(e)end;return j:gsub('([^a-zA-Z0-9])',k)end;function a:build()local l=''if self.path then local m=self.path;m:gsub("([^/]+)",function(j)return i(j)end)l=l..tostring(m)end;if self.query then local n=tostring(self.query)if n~=""then l=l..'?'..n end end;if self.host then local o=self.host;if self.port and self.scheme and a.services[self.scheme]~=self.port then o=o..':'..self.port end;local p;if self.user and self.user~=""then p=self.user;if self.password then p=p..':'..self.password end end;if p and p~=""then o=p..'@'..o end;if o then if l~=""then l='//'..o..'/'..l:gsub('^/+','')else l='//'..o end end end;if self.scheme then l=self.scheme..':'..l end;if self.fragment then l=l..'#'..self.fragment end;return l end;function a.buildQuery(q,r,s)local t={}if not r then r=a.options.separator or'&'end;local u={}for v in pairs(q)do u[#u+1]=v end;table.sort(u)for w,x in ipairs(u)do local y=q[x]x=f(tostring(x))if s then x=string.format('%s[%s]',tostring(s),tostring(x))end;if type(y)=='table'then t[#t+1]=a.buildQuery(y,r,x)else local y=h(tostring(y))if y~=""then t[#t+1]=string.format('%s=%s',x,y)else t[#t+1]=x end end end;return table.concat(t,r)end;function a.parseQuery(d,r)if not r then r=a.options.separator or'&'end;local z={}for s,A in d:gmatch(string.format('([^%q=]+)(=*[^%q=]*)',r,r))do local s=c(s)local u={}s=s:gsub('%[([^%]]*)%]',function(g)if string.find(g,"^-?%d+$")then g=tonumber(g)else g=c(g)end;table.insert(u,g)return"="end)s=s:gsub('=+.*$',"")s=s:gsub('%s',"_")A=A:gsub('^=+',"")if not z[s]then z[s]={}end;if#u>0 and type(z[s])~='table'then z[s]={}elseif#u==0 and type(z[s])=='table'then z[s]=c(A)end;local B=z[s]for C,v in ipairs(u)do if type(B)~='table'then B={}end;if v==""then v=#B+1 end;if not B[v]then B[v]={}end;if C==#u then B[v]=c(A)end;B=B[v]end end;setmetatable(z,{__tostring=a.buildQuery})return z end;function a:setQuery(t)local t=t;if type(t)=='table'then t=a.buildQuery(t)end;self.query=a.parseQuery(t)return t end;function a:setAuthority(o)self.authority=o;self.port=nil;self.host=nil;self.userinfo=nil;self.user=nil;self.password=nil;o=o:gsub('^([^@]*)@',function(g)self.userinfo=g;return''end)o=o:gsub("^%[[^%]]+%]",function(g)self.host=g;return''end)o=o:gsub(':([^:]*)$',function(g)self.port=tonumber(g)return''end)if o~=''and not self.host then self.host=o:lower()end;if self.userinfo then local p=self.userinfo;p=p:gsub(':([^:]*)$',function(g)self.password=g;return''end)self.user=p end;return o end;function a.parse(l)local D={}a.setAuthority(D,"")a.setQuery(D,"")local l=tostring(l or'')l=l:gsub('#(.*)$',function(g)D.fragment=g;return''end)l=l:gsub('^([%w][%w%+%-%.]*)%:',function(g)D.scheme=g:lower()return''end)l=l:gsub('%?(.*)',function(g)a.setQuery(D,g)return''end)l=l:gsub('^//([^/]*)',function(g)a.setAuthority(D,g)return''end)D.path=c(l)setmetatable(D,{__index=a,__tostring=a.build})return D end;function a.removeDotSegments(m)local E={}if string.len(m)==0 then return""end;local F=false;local G=false;if string.sub(m,1,1)=="/"then F=true end;if(string.len(m)>1 or F==false)and string.sub(m,-1)=="/"then G=true end;m:gsub('[^/]+',function(e)table.insert(E,e)end)local H={}local I=0;for C,e in ipairs(E)do if e=='..'then if I>0 then I=I-1 end elseif e~="."then I=I+1;H[I]=e end end;local J=""if#H>0 and I>0 then J=table.concat(H,'/',1,I)else J=""end;if F then J='/'..J end;if G then J=J..'/'end;return J end;local function K(L,M)if string.sub(M,1,1)=="/"then return'/'..string.gsub(M,'^[%./]+','')end;local m=L;if M~=""then m='/'..m:gsub("[^/]*$","")end;m=m..M;m=m:gsub("([^/]*%./)",function(j)if j~="./"then return j else return""end end)m=string.gsub(m,"/%.$","/")local N;while N~=m do N=m;m=string.gsub(N,"([^/]*/%.%./)",function(j)if j~="../../"then return""else return j end end)end;m=string.gsub(m,"([^/]*/%.%.?)$",function(j)if j~="../.."then return""else return j end end)local N;while N~=m do N=m;m=string.gsub(N,'^/?%.%./','')end;return'/'..m end;function a:resolve(O)if type(self)=="string"then self=a.parse(self)end;if type(O)=="string"then O=a.parse(O)end;if O.scheme then return O else O.scheme=self.scheme;if not O.authority or O.authority==""then O:setAuthority(self.authority)if not O.path or O.path==""then O.path=self.path;local t=O.query;if not t or not next(t)then O.query=self.query end else O.path=K(self.path,O.path)end end;return O end end;function a:normalize()if type(self)=='string'then self=a.parse(self)end;if self.path then local m=self.path;m=K(m,"")m=string.gsub(m,"//+","/")self.path=m end;return self end;_G["urlParser"]=a